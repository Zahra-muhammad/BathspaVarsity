<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule & Calendar Admin - Bath Spa Sports</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #f5e6e8 0%, #d4e4f7 100%);
  color: #1a1a1a;
  min-height: 100vh;
  padding: 30px;
}

.main-container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 24px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 40px;
  border-bottom: 1px solid #f0f0f0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 1.4rem;
  font-weight: 700;
  color: #667eea;
}

.logo-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.2rem;
}

.user-section {
  display: flex;
  align-items: center;
  gap: 20px;
}

.status-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: #f0f9ff;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 500;
  color: #0066cc;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
}

.notification-icon {
  position: relative;
  width: 40px;
  height: 40px;
  background: #f8f9fa;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.notification-icon:hover {
  background: #e9ecef;
}

.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 18px;
  height: 18px;
  background: #ff6b6b;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  color: white;
  font-weight: 600;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: #f8f9fa;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.user-profile:hover {
  background: #e9ecef;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 0.9rem;
}

.user-name {
  font-weight: 600;
  font-size: 0.95rem;
}

.content-wrapper {
  display: flex;
}

.sidebar {
  width: 260px;
  background: #fafbfc;
  padding: 30px 0;
  border-right: 1px solid #f0f0f0;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 30px;
  color: #6b7280;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  border-left: 3px solid transparent;
}

.nav-item:hover {
  background: rgba(102, 126, 234, 0.05);
  color: #667eea;
}

.nav-item.active {
  background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
  color: #667eea;
  border-left-color: #667eea;
}

.nav-icon {
  font-size: 1.3rem;
}

.main-content {
  flex: 1;
  padding: 40px;
}

.page-header {
  margin-bottom: 30px;
}

.page-title {
  font-size: 2rem;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 8px;
}

.page-subtitle {
  color: #6b7280;
  font-size: 0.95rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 24px;
  margin-bottom: 40px;
}

.stat-card {
  background: white;
  border: 1px solid #f0f0f0;
  border-radius: 16px;
  padding: 24px;
  transition: all 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
  border-color: #667eea;
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
}

.stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.stat-icon.blue {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.stat-icon.green {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
}

.stat-icon.orange {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.stat-icon.pink {
  background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
  color: white;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 6px;
}

.stat-label {
  color: #6b7280;
  font-size: 0.9rem;
  font-weight: 500;
}

.tabs {
  display: flex;
  gap: 12px;
  margin-bottom: 30px;
  border-bottom: 2px solid #f0f0f0;
}

.tab-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  color: #6b7280;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: -2px;
  font-family: 'Inter', sans-serif;
}

.tab-btn:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.tab-btn.active {
  color: #667eea;
  border-bottom-color: #667eea;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.section-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: #1a1a1a;
}

.section-subtitle {
  color: #6b7280;
  font-size: 0.9rem;
  margin-top: 4px;
}

.btn-primary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: #f8f9fa;
  color: #1a1a1a;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.btn-secondary:hover {
  background: #e9ecef;
}

.btn-danger {
  padding: 8px 16px;
  background: #ff6b6b;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.btn-danger:hover {
  background: #ff5252;
  transform: scale(1.05);
}

.table-container {
  background: white;
  border: 1px solid #f0f0f0;
  border-radius: 16px;
  overflow: hidden;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table thead {
  background: #fafbfc;
}

.data-table th {
  padding: 16px;
  text-align: left;
  font-weight: 600;
  color: #6b7280;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #f0f0f0;
}

.data-table td {
  padding: 16px;
  border-bottom: 1px solid #f0f0f0;
  color: #1a1a1a;
  font-size: 0.95rem;
}

.data-table tbody tr:hover {
  background: rgba(102, 126, 234, 0.02);
}

.data-table tbody tr:last-child td {
  border-bottom: none;
}

.status-badge-table {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}

.status-upcoming {
  background: #e0f2fe;
  color: #0284c7;
}

.status-today {
  background: #d1fae5;
  color: #059669;
}

.status-past {
  background: #fee2e2;
  color: #dc2626;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 24px;
}

.calendar-event-card {
  background: white;
  border: 1px solid #f0f0f0;
  border-radius: 16px;
  padding: 24px;
  transition: all 0.3s ease;
}

.calendar-event-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
  border-color: #667eea;
}

.event-date-badge {
  display: inline-block;
  padding: 6px 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 12px;
}

.event-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 8px;
}

.event-description {
  color: #6b7280;
  font-size: 0.9rem;
  line-height: 1.6;
  margin-bottom: 16px;
}

.event-type-badge {
  display: inline-block;
  padding: 4px 10px;
  background: #f0f9ff;
  color: #0066cc;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 500;
  text-transform: capitalize;
  margin-bottom: 16px;
}

.event-actions {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #f0f0f0;
}

.activities-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.activity-item-card {
  background: white;
  border: 1px solid #f0f0f0;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s ease;
}

.activity-item-card:hover {
  transform: translateX(4px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
  border-color: #10b981;
}

.activity-info {
  flex: 1;
}

.activity-player {
  font-weight: 700;
  color: #1a1a1a;
  font-size: 1rem;
  margin-bottom: 4px;
}

.activity-event {
  color: #6b7280;
  font-size: 0.9rem;
}

.activity-time {
  color: #10b981;
  font-size: 0.85rem;
  font-weight: 600;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
  font-size: 1rem;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px 28px;
  border-bottom: 1px solid #f0f0f0;
}

.modal-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1a1a1a;
}

.close-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f8f9fa;
  border: none;
  border-radius: 8px;
  font-size: 1.5rem;
  color: #6b7280;
  cursor: pointer;
  transition: all 0.3s ease;
}

.close-btn:hover {
  background: #e9ecef;
  color: #1a1a1a;
}

.modal-content form {
  padding: 28px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #1a1a1a;
  font-size: 0.95rem;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  font-size: 0.95rem;
  font-family: 'Inter', sans-serif;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding-top: 20px;
  border-top: 1px solid #f0f0f0;
  margin-top: 20px;
}

@media (max-width: 1200px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  body {
    padding: 10px;
  }

  .top-bar {
    flex-wrap: wrap;
    padding: 16px 20px;
  }

  .sidebar {
    display: none;
  }

  .main-content {
    padding: 20px;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .page-title {
    font-size: 1.5rem;
  }

  .tabs {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .calendar-grid {
    grid-template-columns: 1fr;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .modal-content {
    width: 95%;
    max-height: 95vh;
  }

  .data-table {
    font-size: 0.85rem;
  }

  .data-table th,
  .data-table td {
    padding: 12px 8px;
  }
}
  </style>
</head>
<body>


  <div class="main-container">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="logo">
        <div class="logo-icon">üìÖ</div>
        <span>Schedule & Calendar Management</span>
      </div>

      <div class="user-section">
        <div class="status-badge">
          <span class="status-dot"></span>
          <span>Admin Mode</span>
        </div>

        <div class="notification-icon">
          <span>üîî</span>
          <span class="notification-badge">3</span>
        </div>

        <div class="user-profile">
          <div class="user-avatar">AD</div>
          <span class="user-name">Admin</span>
          <span>‚ñæ</span>
        </div>
      </div>
    </div>

    <div class="content-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar">
        <a href="/admin/adminhome" class="nav-item">
          <span class="nav-icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="/admin/users" class="nav-item">
          <span class="nav-icon">üë•</span>
          <span>User Management</span>
        </a>
        <a href="/admin/shop" class="nav-item">
          <span class="nav-icon">üõçÔ∏è</span>
          <span>Shop Management</span>
        </a>
        <a href="/admin/watch-sports" class="nav-item">
          <span class="nav-icon">üì∫</span>
          <span>Watch Sports</span>
        </a>
        <a href="/admin/schedule" class="nav-item active">
          <span class="nav-icon">üìÖ</span>
          <span>Schedule & Calendar</span>
        </a>
        <a href="/admin/manage-events" class="nav-item">
          <span class="nav-icon">üéØ</span>
          <span>Events Management</span>
        </a>
        <a href="/" class="nav-item">
          <span class="nav-icon">üè†</span>
          <span>Main Site</span>
        </a>
        <a href="/logout" class="nav-item">
          <span class="nav-icon">üö™</span>
          <span>Logout</span>
        </a>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div class="page-header">
          <h1 class="page-title">Schedule & Calendar Manager</h1>
          <p class="page-subtitle">Manage player schedules and calendar events. Completed schedules automatically move to activity history.</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon blue">üìã</div>
            </div>
            <div class="stat-value" id="totalSchedules">0</div>
            <div class="stat-label">Active Schedules</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon green">‚úÖ</div>
            </div>
            <div class="stat-value" id="totalActivities">0</div>
            <div class="stat-label">Completed Activities</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon orange">üìÖ</div>
            </div>
            <div class="stat-value" id="totalCalendarEvents">0</div>
            <div class="stat-label">Calendar Events</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon pink">‚è∞</div>
            </div>
            <div class="stat-value" id="upcomingToday">0</div>
            <div class="stat-label">Today's Events</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="schedules">
            <span>üìã</span>
            <span>Schedules</span>
          </button>
          <button class="tab-btn" data-tab="calendar">
            <span>üìÖ</span>
            <span>Calendar Events</span>
          </button>
          <button class="tab-btn" data-tab="activities">
            <span>‚úÖ</span>
            <span>Activity History</span>
          </button>
        </div>

        <!-- Schedules Tab -->
        <div class="tab-content active" id="schedules-tab">
          <div class="section-header">
            <h2 class="section-title">Player Schedules</h2>
            <button class="btn-primary" id="addScheduleBtn">
              <span>‚ûï</span>
              <span>Add Schedule</span>
            </button>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>

                  <th>Date</th>
                  <th>Time</th>
                  <th>Event</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="schedulesTableBody">
                <tr>
                  <td colspan="6" class="empty-state">No schedules found. Add your first schedule!</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Calendar Tab -->
        <div class="tab-content" id="calendar-tab">
          <div class="section-header">
            <h2 class="section-title">Calendar Events</h2>
            <button class="btn-primary" id="addCalendarBtn">
              <span>‚ûï</span>
              <span>Add Calendar Event</span>
            </button>
          </div>

          <div class="calendar-grid" id="calendarGrid">
            <div class="empty-state">No calendar events found. Add your first event!</div>
          </div>
        </div>

        <!-- Activities Tab -->
        <div class="tab-content" id="activities-tab">
          <div class="section-header">
            <h2 class="section-title">Activity History</h2>
            <p class="section-subtitle">Completed schedules appear here automatically</p>
          </div>

          <div class="activities-list" id="activitiesList">
            <div class="empty-state">No completed activities yet.</div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Schedule Modal -->
  <div class="modal" id="addScheduleModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Schedule</h2>
        <button class="close-btn" id="closeScheduleModal">&times;</button>
      </div>
      <form id="addScheduleForm">


        <div class="form-row">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="scheduleDate" required>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="time" id="scheduleTime" required>
          </div>
        </div>

        <div class="form-group">
          <label>Event Name</label>
          <input type="text" id="scheduleEvent" placeholder="e.g., Basketball Practice" required>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancelSchedule">Cancel</button>
          <button type="submit" class="btn-primary">Add Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Calendar Event Modal -->
  <div class="modal" id="addCalendarModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Calendar Event</h2>
        <button class="close-btn" id="closeCalendarModal">&times;</button>
      </div>
      <form id="addCalendarForm">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="calendarTitle" placeholder="e.g., Championship Finals" required>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="date" id="calendarDate" required>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="calendarDescription" rows="3" placeholder="Event details..."></textarea>
        </div>

        <div class="form-group">
          <label>Event Type</label>
          <select id="calendarType" required>
            <option value="training">Training</option>
            <option value="match">Match</option>
            <option value="tournament">Tournament</option>
            <option value="meeting">Meeting</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancelCalendar">Cancel</button>
          <button type="submit" class="btn-primary">Add Event</button>
        </div>
      </form>
    </div>
  </div>



  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <script>
// =========================
// GLOBAL STATE
// =========================
let schedules = [];
let activities = [];
let calendarEvents = [];
let currentAdminUser = null;

// =========================
// INITIALIZATION
// =========================
document.addEventListener("DOMContentLoaded", () => {
  loadCurrentUser();
  loadSchedulesFromServer();
  loadActivitiesFromServer();
  loadCalendarEventsFromServer();
  
  // Schedule form
  document.getElementById("addScheduleForm").addEventListener("submit", submitSchedule);
  document.getElementById("addScheduleBtn").addEventListener("click", openScheduleModal);
  document.getElementById("closeScheduleModal").addEventListener("click", closeScheduleModal);
  document.getElementById("cancelSchedule").addEventListener("click", closeScheduleModal);
  
  // Calendar form
  document.getElementById("addCalendarForm").addEventListener("submit", submitCalendarEvent);
  document.getElementById("addCalendarBtn").addEventListener("click", openCalendarModal);
  document.getElementById("closeCalendarModal").addEventListener("click", closeCalendarModal);
  document.getElementById("cancelCalendar").addEventListener("click", closeCalendarModal);
  
  // Tab switching
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
  });
  
  // Close modals when clicking outside
  window.addEventListener("click", (e) => {
    if (e.target.classList.contains("modal")) {
      closeScheduleModal();
      closeCalendarModal();
    }
  });
  
  // Check for completed schedules every minute and move to activities
  setInterval(movePastSchedulesToActivities, 60000);
  
  // Initial check on load
  setTimeout(movePastSchedulesToActivities, 1000);
});

// =========================
// LOAD CURRENT USER
// =========================
async function loadCurrentUser() {
  try {
    const response = await fetch('/users/current-user', {
      credentials: 'include'
    });
    if (response.ok) {
      currentAdminUser = await response.json();
      console.log('‚úÖ Current admin user loaded:', currentAdminUser.name);
    } else {
      console.log('‚ö†Ô∏è Could not load current user');
    }
  } catch (err) {
    console.log('‚ö†Ô∏è Could not load current user, will save schedules without userId');
  }
}

// =========================
// TAB SWITCHING
// =========================
function switchTab(tabName) {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.classList.remove("active");
  });
  document.querySelector(`[data-tab="${tabName}"]`).classList.add("active");
  
  document.querySelectorAll(".tab-content").forEach(content => {
    content.classList.remove("active");
  });
  document.getElementById(`${tabName}-tab`).classList.add("active");
}

// =========================
// MODAL FUNCTIONS
// =========================
function openScheduleModal() {
  document.getElementById("addScheduleModal").classList.add("active");
}

function closeScheduleModal() {
  document.getElementById("addScheduleModal").classList.remove("active");
  document.getElementById("addScheduleForm").reset();
}

function openCalendarModal() {
  document.getElementById("addCalendarModal").classList.add("active");
}

function closeCalendarModal() {
  document.getElementById("addCalendarModal").classList.remove("active");
  document.getElementById("addCalendarForm").reset();
}

// =========================
// LOAD DATA FROM SERVER
// =========================
async function loadSchedulesFromServer() {
  try {
    const res = await fetch("/api/schedules", {
      credentials: 'include'
    });
    
    if (res.ok) {
      schedules = await res.json();
      console.log('‚úÖ Schedules loaded:', schedules.length);
    } else if (res.status === 404) {
      console.log('‚ö†Ô∏è Schedules endpoint not found - using local storage');
      schedules = JSON.parse(localStorage.getItem('schedules') || '[]');
    } else {
      console.log('‚ö†Ô∏è Schedules API error:', res.status);
      schedules = JSON.parse(localStorage.getItem('schedules') || '[]');
    }
  } catch (err) {
    console.error("Error loading schedules:", err);
    console.log('üì¶ Using local storage fallback');
    schedules = JSON.parse(localStorage.getItem('schedules') || '[]');
  }
  
  renderSchedules();
  updateStats();
}

async function loadActivitiesFromServer() {
  try {
    const res = await fetch("/api/activities", {
      credentials: 'include'
    });
    
    if (res.ok) {
      activities = await res.json();
      console.log('‚úÖ Activities loaded:', activities.length);
    } else if (res.status === 404) {
      console.log('‚ö†Ô∏è Activities endpoint not found - using local storage');
      activities = JSON.parse(localStorage.getItem('activities') || '[]');
    } else {
      console.log('‚ö†Ô∏è Activities API error:', res.status);
      activities = JSON.parse(localStorage.getItem('activities') || '[]');
    }
  } catch (err) {
    console.error("Error loading activities:", err);
    console.log('üì¶ Using local storage fallback');
    activities = JSON.parse(localStorage.getItem('activities') || '[]');
  }
  renderActivities();
  updateStats();
}

async function loadCalendarEventsFromServer() {
  try {
    const res = await fetch("/api/calendar-events", {
      credentials: 'include'
    });
    
    if (res.ok) {
      calendarEvents = await res.json();
      console.log('‚úÖ Calendar events loaded:', calendarEvents.length);
    } else if (res.status === 404) {
      console.log('‚ö†Ô∏è Calendar events endpoint not found - using local storage');
      calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
    } else {
      console.log('‚ö†Ô∏è Calendar events API error:', res.status);
      calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
    }
  } catch (err) {
    console.error("Error loading calendar events:", err);
    console.log('üì¶ Using local storage fallback');
    calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
  }
  renderCalendarEvents();
  updateStats();
}

// =========================
// AUTO-MOVE PAST SCHEDULES TO ACTIVITIES
// =========================
function movePastSchedulesToActivities() {
  console.log('üîÑ Checking for past schedules to convert to activities...');
  
  let hasChanges = false;
  const now = new Date();
  
  // Find all past schedules
  const pastSchedules = schedules.filter(schedule => {
    const scheduleDateTime = new Date(`${schedule.date}T${schedule.time}`);
    return scheduleDateTime < now || schedule.status === 'past';
  });
  
  console.log(`üìã Found ${pastSchedules.length} past schedules`);
  
  // Convert each past schedule to activity
  pastSchedules.forEach(schedule => {
    // Check if this activity already exists
    const exists = activities.some(a => 
      a.event === schedule.event && 
      a.completedAt && 
      a.completedAt.startsWith(schedule.date)
    );
    
    if (!exists) {
      console.log(`‚úÖ Converting to activity: ${schedule.event}`);
      
      const completedAt = new Date(`${schedule.date}T${schedule.time}`).toISOString();
      
      const activity = {
        _id: `activity_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        userId: schedule.userId,
        event: schedule.event,
        completedAt
      };
      
      activities.unshift(activity);
      saveActivityToServer(activity);
      hasChanges = true;
    }
    
    // Remove the past schedule from schedules array
    const index = schedules.findIndex(s => s._id === schedule._id);
    if (index !== -1) {
      schedules.splice(index, 1);
      deleteScheduleFromServer(schedule._id);
      hasChanges = true;
    }
  });
  
  if (hasChanges) {
    console.log('üíæ Saving changes to storage...');
    localStorage.setItem('schedules', JSON.stringify(schedules));
    localStorage.setItem('activities', JSON.stringify(activities));
    renderSchedules();
    renderActivities();
    updateStats();
    
    if (pastSchedules.length > 0) {
      showNotification(`Moved ${pastSchedules.length} past schedule(s) to Activity History`);
    }
  }
}

// =========================
// SUBMIT FUNCTIONS
// =========================
async function submitSchedule(e) {
  e.preventDefault();

  const date = document.getElementById("scheduleDate").value;
  const time = document.getElementById("scheduleTime").value;
  const eventName = document.getElementById("scheduleEvent").value.trim();

  if (!date || !time || !eventName) {
    alert("All fields are required!");
    return;
  }

  const newSchedule = {
    _id: Date.now().toString(),
    date,
    time,
    event: eventName,
    status: getScheduleStatus(date, time),
    userId: currentAdminUser ? currentAdminUser._id : null,
    createdAt: new Date().toISOString()
  };

  console.log('üìã Creating schedule:', newSchedule);

  try {
    const saved = await saveScheduleToServer(newSchedule);
    if (saved) {
      schedules.push(saved);
    } else {
      schedules.push(newSchedule);
    }
    
    localStorage.setItem('schedules', JSON.stringify(schedules));
    
    renderSchedules();
    updateStats();
    closeScheduleModal();
    showNotification("Schedule added successfully!");
  } catch (err) {
    console.error('‚ùå Failed to save schedule:', err);
    schedules.push(newSchedule);
    localStorage.setItem('schedules', JSON.stringify(schedules));
    renderSchedules();
    updateStats();
    closeScheduleModal();
    showNotification("Schedule saved locally (server unavailable)");
  }
}

async function submitCalendarEvent(e) {
  e.preventDefault();

  const title = document.getElementById("calendarTitle").value.trim();
  const date = document.getElementById("calendarDate").value;
  const description = document.getElementById("calendarDescription").value.trim();
  const type = document.getElementById("calendarType").value;

  if (!title || !date) {
    alert("Title and date are required!");
    return;
  }

  const newEvent = {
    _id: Date.now().toString(),
    title,
    date,
    description,
    type,
    createdAt: new Date().toISOString()
  };

  console.log('üìÖ Creating calendar event:', newEvent);

  try {
    const saved = await saveCalendarEventToServer(newEvent);
    if (saved) {
      calendarEvents.push(saved);
    } else {
      calendarEvents.push(newEvent);
    }
    
    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
    
    renderCalendarEvents();
    updateStats();
    closeCalendarModal();
    showNotification("Calendar event added successfully!");
  } catch (err) {
    console.error('‚ùå Failed to save calendar event:', err);
    calendarEvents.push(newEvent);
    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
    renderCalendarEvents();
    updateStats();
    closeCalendarModal();
    showNotification("Calendar event saved locally (server unavailable)");
  }
}

// =========================
// SAVE TO SERVER WITH FALLBACK
// =========================
async function saveScheduleToServer(schedule) {
  console.log('üíæ Attempting to save schedule to server:', schedule);
  
  try {
    const response = await fetch("/api/schedules", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json"
      },
      credentials: 'include',
      body: JSON.stringify(schedule)
    });
    
    console.log('üì° Server response status:', response.status);
    
    if (response.ok) {
      const savedSchedule = await response.json();
      console.log('‚úÖ Schedule saved successfully:', savedSchedule);
      return savedSchedule;
    } else if (response.status === 404) {
      console.log('‚ö†Ô∏è API endpoint not found - using local storage');
      return null;
    } else {
      const errorText = await response.text();
      console.error('‚ùå Server error:', errorText);
      return null;
    }
  } catch (err) {
    console.error("‚ùå Network error saving schedule:", err);
    console.log('üì¶ Falling back to local storage');
    return null;
  }
}

async function saveCalendarEventToServer(event) {
  console.log('üíæ Attempting to save calendar event to server:', event);
  
  try {
    const response = await fetch("/api/calendar-events", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json"
      },
      credentials: 'include',
      body: JSON.stringify(event)
    });
    
    console.log('üì° Server response status:', response.status);
    
    if (response.ok) {
      const savedEvent = await response.json();
      console.log('‚úÖ Calendar event saved successfully:', savedEvent);
      return savedEvent;
    } else if (response.status === 404) {
      console.log('‚ö†Ô∏è API endpoint not found - using local storage');
      return null;
    } else {
      const errorText = await response.text();
      console.error('‚ùå Server error:', errorText);
      return null;
    }
  } catch (err) {
    console.error("‚ùå Network error saving calendar event:", err);
    console.log('üì¶ Falling back to local storage');
    return null;
  }
}

async function saveActivityToServer(activity) {
  try {
    const response = await fetch("/api/activities", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: 'include',
      body: JSON.stringify(activity)
    });
    
    if (response.ok) {
      console.log('‚úÖ Activity saved to server');
    }
  } catch (err) {
    console.error("Error saving activity to server:", err);
  }
}

// =========================
// DELETE OPERATIONS
// =========================
async function deleteSchedule(id) {
  if (!confirm("Are you sure you want to delete this schedule?")) return;
  
  schedules = schedules.filter(s => s._id !== id);
  localStorage.setItem('schedules', JSON.stringify(schedules));
  renderSchedules();
  updateStats();

  await deleteScheduleFromServer(id);
  showNotification("Schedule deleted successfully!");
}

async function deleteScheduleFromServer(id) {
  try {
    await fetch(`/api/schedules/${id}`, { 
      method: "DELETE",
      credentials: 'include'
    });
  } catch (err) {
    console.error("Error deleting schedule from server:", err);
  }
}

async function deleteCalendarEvent(id) {
  if (!confirm("Are you sure you want to delete this event?")) return;
  
  calendarEvents = calendarEvents.filter(e => e._id !== id);
  localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
  renderCalendarEvents();
  updateStats();

  try {
    await fetch(`/api/calendar-events/${id}`, { 
      method: "DELETE",
      credentials: 'include'
    });
    showNotification("Calendar event deleted successfully!");
  } catch (err) {
    console.error("Error deleting calendar event from server:", err);
    showNotification("Calendar event deleted locally");
  }
}

// =========================
// NOTIFICATION
// =========================
function showNotification(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    z-index: 10000;
    font-weight: 600;
    animation: slideIn 0.3s ease;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// =========================
// SCHEDULE STATUS
// =========================
function getScheduleStatus(date, time) {
  const now = new Date();
  const scheduleDateTime = new Date(`${date}T${time}`);
  
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
  
  if (scheduleDateTime < now) {
    return "past";
  } else if (scheduleDateTime >= todayStart && scheduleDateTime < todayEnd) {
    return "today";
  } else {
    return "upcoming";
  }
}

// =========================
// RENDER FUNCTIONS
// =========================
function renderSchedules() {
  const tbody = document.getElementById("schedulesTableBody");
  
  // Filter out past schedules - they should be in activities now
  const activeSchedules = schedules.filter(s => {
    const status = getScheduleStatus(s.date, s.time);
    return status !== 'past';
  });
  
  if (activeSchedules.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No active schedules. Add your first schedule!</td></tr>';
    return;
  }
  
  tbody.innerHTML = "";

  const sortedSchedules = [...activeSchedules].sort((a, b) => {
    const dateA = new Date(`${a.date}T${a.time}`);
    const dateB = new Date(`${b.date}T${b.time}`);
    return dateA - dateB;
  });

  sortedSchedules.forEach(schedule => {
    const status = getScheduleStatus(schedule.date, schedule.time);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${formatDate(schedule.date)}</td>
      <td>${formatTime(schedule.time)}</td>
      <td>${schedule.event}</td>
      <td><span class="status-badge-table status-${status}">${capitalizeFirst(status)}</span></td>
      <td><button class="btn-danger" onclick="deleteSchedule('${schedule._id}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function renderCalendarEvents() {
  const grid = document.getElementById("calendarGrid");
  
  if (calendarEvents.length === 0) {
    grid.innerHTML = '<div class="empty-state">No calendar events found. Add your first event!</div>';
    return;
  }
  
  grid.innerHTML = "";

  const sortedEvents = [...calendarEvents].sort((a, b) => 
    new Date(a.date) - new Date(b.date)
  );

  sortedEvents.forEach(event => {
    const card = document.createElement("div");
    card.className = "calendar-event-card";
    
    card.innerHTML = `
      <div class="event-date-badge">${formatDate(event.date)}</div>
      <div class="event-type-badge">${event.type}</div>
      <div class="event-title">${event.title}</div>
      <div class="event-description">${event.description || 'No description provided.'}</div>
      <div class="event-actions">
        <button class="btn-danger" onclick="deleteCalendarEvent('${event._id}')">Delete Event</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

function renderActivities() {
  const container = document.getElementById("activitiesList");
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state">No completed activities yet. Past schedules will appear here.</div>';
    return;
  }
  
  container.innerHTML = "";

  const sortedActivities = [...activities].sort((a, b) => 
    new Date(b.completedAt) - new Date(a.completedAt)
  );

  sortedActivities.forEach(a => {
    const card = document.createElement("div");
    card.className = "activity-item-card";
    card.innerHTML = `
      <div class="activity-info">
        <div class="activity-player">${a.event}</div>
        <div class="activity-event">Completed Activity</div>
      </div>
      <div class="activity-time">${formatDate(a.completedAt)} ‚Ä¢ ${formatTimeFromISO(a.completedAt)}</div>
    `;
    container.appendChild(card);
  });
}

// =========================
// UPDATE STATS
// =========================
function updateStats() {
  const activeSchedules = schedules.filter(s => {
    const status = getScheduleStatus(s.date, s.time);
    return status === "upcoming" || status === "today";
  }).length;
  
  document.getElementById("totalSchedules").textContent = activeSchedules;
  document.getElementById("totalActivities").textContent = activities.length;
  document.getElementById("totalCalendarEvents").textContent = calendarEvents.length;
  
  const today = new Date().toISOString().split('T')[0];
  const todaySchedules = schedules.filter(s => s.date === today).length;
  const todayCalendar = calendarEvents.filter(e => e.date === today).length;
  document.getElementById("upcomingToday").textContent = todaySchedules + todayCalendar;
}

// =========================
// HELPER FUNCTIONS
// =========================
function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric' 
  });
}

function formatTime(timeStr) {
  const [hours, minutes] = timeStr.split(':');
  const date = new Date();
  date.setHours(parseInt(hours), parseInt(minutes));
  return date.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true 
  });
}

function formatTimeFromISO(iso) {
  return new Date(iso).toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true 
  });
}

function capitalizeFirst(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// Make functions globally accessible
window.deleteSchedule = deleteSchedule;
window.deleteCalendarEvent = deleteCalendarEvent;
</script>
</body>
</html>